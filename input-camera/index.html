<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Input Camera</title>
	<link rel="stylesheet" href="../style.css">
	<style>
		video {
			background-color: #ccc;
			margin: 2.618em 0;
		}
		form {
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="container">

		<h1>カメラの映像を入力</h1>

		<div id="video-input-container">
			<video id="video-input" loop autoplay muted width="640" height="360"></video>
			<form id="control"></form>
		</div>

	</div><!-- /container -->

	<script>

		// 参考： http://qiita.com/shinido/items/a80e5706f466b81646e2
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		var URL = window.URL || window.webkitURL;
		var RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
		var RTCSessionDescription = window.RTCSessionDescription || window.webkitRTCSessionDescription || window.mozRTCSessionDescription;
		var RTCIceCandidate = window.RTCIceCandidate || window.webkitRTCIceCandidate || window.mozRTCIceCandidate;


		var mediaC = {
			'mandatory': {
				'OfferToReceiveAudio': true,
				'OfferToReceiveVideo': true
			}
		};
		var ice_config = {
			"iceServers": []
		};


		// input video
		function getVideoSources(callback) {
			if (!navigator.mediaDevices) {
				console.log("MediaStreamTrack");
				MediaStreamTrack.getSources(function(cams) {
					cams.forEach(function(c, i, a) {
						if (c.kind != 'video') return;
						callback({
							name: c.facing,
							id: c.id
						});
					});
				});
			} else {
				navigator.mediaDevices.enumerateDevices().then(function(cams) {
					cams.forEach(function(c, i, a) {
						console.log("mediaDevices", c);
						if (c.kind != 'videoinput') return;
						callback({
							name: c.label,
							id: c.deviceId
						});
					});
				});
			}
		}

	</script>

	<script>
		var video = document.getElementById("video-input");
		var control = document.getElementById("control");

		getVideoSources(function(cam) {
			console.log("cam", cam);
			var button = document.createElement("input");
			button.type = "button";
			button.className = "button";
			if (cam.name) {
				button.value = cam.name;
			} else {
				button.value = "Camera";
			}
			button.onclick = getMain(cam.id);
			control.appendChild(button);
			console.log('add button');
		});

		function getMain(cam_id) {
			return function() {
				main(cam_id);
			};
		}

		function main(cam_id) {
			navigator.getUserMedia({
				audio: false,
				video: {
					optional: [
						{ sourceId: cam_id}
					]
				}
			}, function(stream) { // success
				console.log("Start Video", stream);
				localStream = stream;
				video.src = URL.createObjectURL(stream);
				video.play();
				video.volume = 0;
			}, function(e) { // error
				console.error("Error on start video: " + e.code);
			});
		};
	</script>
</body>
</html>